{"version":3,"sources":["assets\\script\\Ui\\UiLoad.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import UIPage from \"./UIPage\";\r\nimport { cocosz } from \"../Framework/CocosZ\";\r\nimport Constant, { PageName } from \"../Framework/Constant\";\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport default class UiLoad extends UIPage {\r\n\r\n    private _progress: cc.ProgressBar = null;\r\n    private package1: boolean = false;\r\n    private package2: boolean = false;\r\n\r\n    private num: cc.Label = null;\r\n    constructor() {\r\n        super();\r\n        this._init();\r\n    }\r\n    private _init() {\r\n        lieyou_SdkManager.init(\r\n            console.log(\"广告初始化完成！\")\r\n        );\r\n        let Game: cc.Prefab = cocosz.resMgr.getRes(PageName.UiLoad, cc.Prefab);\r\n        if (Game) {\r\n            let node: cc.Node = cc.instantiate(Game);\r\n            if (node) {\r\n                this._page = node;\r\n                cc.find(\"Canvas\").addChild(node);\r\n                node.active = false;\r\n                node.position = cc.Vec3.ZERO;\r\n                this._onLoad();\r\n            }\r\n        }\r\n    }\r\n\r\n    loadSubpackage(func) {\r\n        var subpackages = [];\r\n        var file_max = 0;//需要加载的文件总数\r\n        var file_ach = 0;//已加载的文件数\r\n        var _subpackages = cc.loader.downloader._subpackages;\r\n        for (var a in _subpackages) {\r\n            var subpackage = _subpackages[a];\r\n            var len = 1;\r\n            if (subpackage.uuids) {\r\n                len = subpackage.uuids.length;\r\n            }\r\n            file_max += len;\r\n            subpackages.push({ name: subpackage.name, file_num: len });\r\n        }\r\n        var loadsub = (index) => {\r\n            if (subpackages.length == index) {\r\n                func && func(1);//加载完成回调\r\n                return;\r\n            }\r\n            console.log('加载分包', subpackages[index].name);\r\n            cc.loader.downloader.loadSubpackage(subpackages[index].name, (res) => {\r\n                //(已加载的文件数+当前分包加载进度*当前包文件数)/文件总数\r\n                if (res) {\r\n                    var progress = (file_ach + (res.progress / 100) * subpackages[index].file_num) / file_max;\r\n                    if (progress < 1) (func && func(progress));//防止出现两次加载完成回调\r\n                }\r\n                else {\r\n                    file_ach += subpackages[index].file_num;\r\n                    var progress = (file_ach) / file_max;\r\n                    if (progress < 1) (func && func(progress));//防止出现两次加载完成回调\r\n                    loadsub(index + 1);\r\n                }\r\n            }, (err) => {\r\n                if (err) {\r\n                    console.log(err);\r\n                    func && func(0);\r\n                } else {\r\n                    file_ach += subpackages[index].file_num;\r\n                    var progress = (file_ach) / file_max;\r\n                    if (progress < 1) (func && func(progress));//防止出现两次加载完成回调\r\n                    loadsub(index + 1);\r\n                }\r\n            });\r\n        }\r\n        loadsub(0);\r\n    }\r\n\r\n    private _onLoad() {\r\n        this._progress = this._page.getChildByName(\"scaleNode\").getChildByName(\"ProgressBar\").getComponent(cc.ProgressBar);\r\n        this.num = this._page.getChildByName(\"scaleNode\").getChildByName(\"num\").getComponent(cc.Label);\r\n        this._updateProgress(0);\r\n\r\n        this.loadSubpackage((percent) => {\r\n            cc.game.emit(Constant.E_GAME_LOGIC, { type: Constant.E_UPDATE_PROGRESS, data: percent });\r\n            if (percent == 1) {\r\n                console.log(\"完成分包加载！\")\r\n                cc.game.emit(Constant.E_LOAD_RES);\r\n            }\r\n        });\r\n        \r\n        // if (cc.sys.platform !== cc.sys.WECHAT_GAME) {\r\n        //     lieyou_SdkManager.init();\r\n        // }\r\n\r\n        // cc.debug.setDisplayStats(true);\r\n    }\r\n\r\n    private _updateProgress(percent: number) {\r\n        this._progress.progress = percent;\r\n        this.num.string = Math.round(percent * 100) + \"%\"\r\n    }\r\n\r\n    protected onOpen() {\r\n        this._registerEvent();\r\n    }\r\n\r\n    protected onClose() {\r\n        this._unregisterEvent();\r\n    }\r\n\r\n    protected onDestroy() {\r\n        cc.game.targetOff(this);\r\n    }\r\n\r\n    private _registerEvent() {\r\n        cc.game.on(Constant.E_GAME_LOGIC, this._onGameMessageHandler, this);\r\n    }\r\n\r\n    private _unregisterEvent() {\r\n        cc.game.targetOff(this);\r\n    }\r\n\r\n    private _onGameMessageHandler(event: any) {\r\n        switch (event.type) {\r\n            case Constant.E_UPDATE_PROGRESS: {\r\n                this._updateProgress(event.data);\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n}\r\n"]}